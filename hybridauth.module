<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;

/**
 * Implements hook_form_alter().
 */
function hybridauth_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  // @todo remove this later and use block or widget or whatever.
  if ($form_id == 'user_login_form') {
    $form['hybridauth'] = [
      '#title' => t('Log in with Linkedin'),
      '#type' => 'link',
      '#url' => Url::fromRoute('hybridauth.authenticate', ['provider_id' => 'LinkedIn']),
    ];

    $form['hybridauth_facebook'] = [
      '#title' => t('Log in with Facebook'),
      '#type' => 'link',
      '#url' => Url::fromRoute('hybridauth.authenticate', ['provider_id' => 'Facebook']),
    ];

    $form['hybridauth_google'] = [
      '#title' => t('Log in with Google'),
      '#type' => 'link',
      '#url' => Url::fromRoute('hybridauth.authenticate', ['provider_id' => 'Google']),
    ];

    $form['hybridauth_bitbucket'] = [
      '#title' => t('Log in with BitBucket'),
      '#type' => 'link',
      '#url' => Url::fromRoute('hybridauth.authenticate', ['provider_id' => 'BitBucket']),
    ];

    $form['hybridauth_yahoo'] = [
      '#title' => t('Log in with Yahoo'),
      '#type' => 'link',
      '#url' => Url::fromRoute('hybridauth.authenticate', ['provider_id' => 'Yahoo']),
    ];
  }

}

/**
 * Internal functions.
 */
function hybridauth_providers_list($reset = FALSE) {
  $providers = &drupal_static(__FUNCTION__, NULL);

  $test = hybridauth_providers_files($reset);

  if (!isset($providers)) {
    $raw_providers = [];
    foreach (hybridauth_providers_files($reset) as $name => $file) {
      if (!array_key_exists($name, $raw_providers)) {
        $raw_providers[$name] = t($name);
      }
    }

    $providers = [];
    $enabled_providers = array_filter(\Drupal::state()
      ->get('hybridauth_providers', []));
    foreach (array_keys($enabled_providers + $raw_providers) as $provider_id) {
      $providers[$provider_id] = $raw_providers[$provider_id];
    }
  }

  return $providers;
}

/**
 * Returns available providers files, keyed by filename without extension.
 */
function hybridauth_providers_files($reset = FALSE) {
  $files = [];
  // Try to get cached value if allowed: $reset == FALSE.
  if (!$reset) {
    $cache = \Drupal::cache()->get('hybridauth_providers_files');
    if (!empty($cache->data)) {
      $files = $cache->data;
    }
  }

  // Scan Providers directory if $reset == TRUE or there was no cached value.
  if (empty($files)) {
    // Get base dir of site.
    $basepath = getcwd();
    // Get location ov vendor directory.
    if (!is_dir($basepath . '/vendor/')) {
      $basepath_in_array = explode('/',$basepath);
      $basepath = implode(
        '/',
        array_slice(
          $basepath_in_array,
          0,
          count($basepath_in_array) - 1
        )
      );
    }
    $vendor_path = $basepath . '/vendor';

    $files = \Drupal::service('file_system')
      ->scanDirectory(
        $vendor_path . '/hybridauth/hybridauth/src/Provider',
        '/\.php$/',
        ['key' => 'name']
      );
    \Drupal::cache()->set('hybridauth_providers_files', $files);
  }
  return $files;
}

/**
 * Pre-render callback for the providers tableselect.
 */
function hybridauth_admin_providers_pre_render($element) {
  // Add weight column.
  $element['#header']['weight'] = t('Weight');
  foreach (array_keys($element['#options']) as $provider_id) {
    $key = 'hybridauth_provider_' . $provider_id . '_weight';
    $element['#options'][$provider_id]['weight'] = [
      'data' => \Drupal::service('renderer')->render($element[$key]),
    ];
    unset($element[$key]);
  }

  // Assign id to the table.
  $table_id = 'hybridauth-providers';
  $element['#attributes'] = ['id' => $table_id];

  return $element;
}
